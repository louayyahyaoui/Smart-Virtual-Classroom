{"ast":null,"code":"/**\r\n * DevExtreme (ui/scheduler/ui.scheduler.appointment_model.js)\r\n * Version: 20.2.6\r\n * Build date: Tue Mar 16 2021\r\n *\r\n * Copyright (c) 2012 - 2021 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nexports.default = void 0;\n\nvar _config = _interopRequireDefault(require(\"../../core/config\"));\n\nvar _iterator = require(\"../../core/utils/iterator\");\n\nvar _date_serialization = _interopRequireDefault(require(\"../../core/utils/date_serialization\"));\n\nvar _recurrence = require(\"./recurrence\");\n\nvar _date = _interopRequireDefault(require(\"../../core/utils/date\"));\n\nvar _common = require(\"../../core/utils/common\");\n\nvar _type = require(\"../../core/utils/type\");\n\nvar _array = require(\"../../core/utils/array\");\n\nvar _extend = require(\"../../core/utils/extend\");\n\nvar _query = _interopRequireDefault(require(\"../../data/query\"));\n\nvar _deferred = require(\"../../core/utils/deferred\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\n\nfunction _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n\n    if (\"value\" in descriptor) {\n      descriptor.writable = true;\n    }\n\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\n\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) {\n    _defineProperties(Constructor.prototype, protoProps);\n  }\n\n  if (staticProps) {\n    _defineProperties(Constructor, staticProps);\n  }\n\n  return Constructor;\n}\n\nvar toMs = _date.default.dateToMilliseconds;\nvar DATE_FILTER_POSITION = 0;\nvar USER_FILTER_POSITION = 1;\n\nvar FilterMaker = function () {\n  function FilterMaker(dataAccessors) {\n    this._filterRegistry = null;\n    this._dataAccessors = dataAccessors;\n  }\n\n  var _proto = FilterMaker.prototype;\n\n  _proto.isRegistered = function () {\n    return !!this._filterRegistry;\n  };\n\n  _proto.clearRegistry = function () {\n    delete this._filterRegistry;\n  };\n\n  _proto.make = function (type, args) {\n    if (!this._filterRegistry) {\n      this._filterRegistry = {};\n    }\n\n    this._make(type).apply(this, args);\n  };\n\n  _proto._make = function (type) {\n    var _this = this;\n\n    switch (type) {\n      case \"date\":\n        return function (min, max, useAccessors) {\n          var startDate = useAccessors ? _this._dataAccessors.getter.startDate : _this._dataAccessors.expr.startDateExpr;\n          var endDate = useAccessors ? _this._dataAccessors.getter.endDate : _this._dataAccessors.expr.endDateExpr;\n          var recurrenceRule = _this._dataAccessors.expr.recurrenceRuleExpr;\n          _this._filterRegistry.date = [[[endDate, \">\", min], [startDate, \"<\", max]], \"or\", [recurrenceRule, \"startswith\", \"freq\"], \"or\", [[endDate, min], [startDate, min]]];\n\n          if (!recurrenceRule) {\n            _this._filterRegistry.date.splice(1, 2);\n          }\n        };\n\n      case \"user\":\n        return function (userFilter) {\n          _this._filterRegistry.user = userFilter;\n        };\n    }\n  };\n\n  _proto.combine = function () {\n    var filter = [];\n    this._filterRegistry.date && filter.push(this._filterRegistry.date);\n    this._filterRegistry.user && filter.push(this._filterRegistry.user);\n    return filter;\n  };\n\n  _proto.dateFilter = function () {\n    return this._filterRegistry.date;\n  };\n\n  return FilterMaker;\n}();\n\nvar compareDateWithStartDayHour = function (startDate, endDate, startDayHour, allDay, severalDays) {\n  var startTime = _date.default.dateTimeFromDecimal(startDayHour);\n\n  var result = startDate.getHours() >= startTime.hours && startDate.getMinutes() >= startTime.minutes || endDate.getHours() === startTime.hours && endDate.getMinutes() > startTime.minutes || endDate.getHours() > startTime.hours || severalDays || allDay;\n  return result;\n};\n\nvar compareDateWithEndDayHour = function (startDate, endDate, startDayHour, endDayHour, allDay, severalDays, max, min) {\n  var hiddenInterval = (24 - endDayHour + startDayHour) * toMs(\"hour\");\n  var apptDuration = endDate.getTime() - startDate.getTime();\n  var delta = (hiddenInterval - apptDuration) / toMs(\"hour\");\n  var apptStartHour = startDate.getHours();\n  var apptStartMinutes = startDate.getMinutes();\n  var result;\n\n  var endTime = _date.default.dateTimeFromDecimal(endDayHour);\n\n  var startTime = _date.default.dateTimeFromDecimal(startDayHour);\n\n  result = apptStartHour < endTime.hours || apptStartHour === endTime.hours && apptStartMinutes < endTime.minutes || allDay && startDate <= max || severalDays && startDate < max && endDate > min && (apptStartHour < endTime.hours || 60 * endDate.getHours() + endDate.getMinutes() > 60 * startTime.hours);\n\n  if (apptDuration < hiddenInterval) {\n    if (apptStartHour > endTime.hours && apptStartMinutes > endTime.minutes && delta <= apptStartHour - endDayHour) {\n      result = false;\n    }\n  }\n\n  return result;\n};\n\nvar AppointmentModel = function () {\n  function AppointmentModel(dataSource, dataAccessors, baseAppointmentDuration) {\n    this.setDataAccessors(dataAccessors);\n    this.setDataSource(dataSource);\n    this._updatedAppointmentKeys = [];\n    this._filterMaker = new FilterMaker(dataAccessors);\n    this._baseAppointmentDuration = baseAppointmentDuration;\n  }\n\n  var _proto2 = AppointmentModel.prototype;\n\n  _proto2._createFilter = function (min, max, remoteFiltering, dateSerializationFormat) {\n    this._filterMaker.make(\"date\", [min, max]);\n\n    var userFilterPosition = this._excessFiltering() ? this._dataSource.filter()[USER_FILTER_POSITION] : this._dataSource.filter();\n\n    this._filterMaker.make(\"user\", [userFilterPosition]);\n\n    if (remoteFiltering) {\n      this._dataSource.filter(this._combineRemoteFilter(dateSerializationFormat));\n    }\n  };\n\n  _proto2._excessFiltering = function () {\n    var dateFilter = this._filterMaker.dateFilter();\n\n    var dataSourceFilter = this._dataSource.filter();\n\n    return dataSourceFilter && ((0, _common.equalByValue)(dataSourceFilter, dateFilter) || dataSourceFilter.length && (0, _common.equalByValue)(dataSourceFilter[DATE_FILTER_POSITION], dateFilter));\n  };\n\n  _proto2._combineFilter = function () {\n    return this._filterMaker.combine();\n  };\n\n  _proto2._getStoreKey = function (target) {\n    var store = this._dataSource.store();\n\n    return store.keyOf(target);\n  };\n\n  _proto2._filterAppointmentByResources = function (appointment, resources) {\n    var _this2 = this;\n\n    var result = false;\n    var i;\n    var len;\n    var resourceName;\n\n    var checkAppointmentResourceValues = function () {\n      var resourceGetter = _this2._dataAccessors.getter.resources[resourceName];\n      var resource;\n\n      if ((0, _type.isFunction)(resourceGetter)) {\n        resource = resourceGetter(appointment);\n      }\n\n      var appointmentResourceValues = (0, _array.wrapToArray)(resource);\n      var resourceData = (0, _iterator.map)(resources[i].items, function (item) {\n        return item.id;\n      });\n\n      for (var j = 0, itemDataCount = appointmentResourceValues.length; j < itemDataCount; j++) {\n        if ((0, _array.inArray)(appointmentResourceValues[j], resourceData) > -1) {\n          return true;\n        }\n      }\n\n      return false;\n    };\n\n    for (i = 0, len = resources.length; i < len; i++) {\n      resourceName = resources[i].name;\n      result = checkAppointmentResourceValues.call(this);\n\n      if (!result) {\n        return false;\n      }\n    }\n\n    return result;\n  };\n\n  _proto2._filterAppointmentByRRule = function (appointment, min, max, startDayHour, endDayHour, firstDayOfWeek) {\n    var recurrenceRule = appointment.recurrenceRule;\n    var recurrenceException = appointment.recurrenceException;\n    var allDay = appointment.allDay;\n    var result = true;\n    var appointmentStartDate = appointment.startDate;\n    var appointmentEndDate = appointment.endDate;\n    var recurrenceProcessor = (0, _recurrence.getRecurrenceProcessor)();\n\n    if (allDay || this._appointmentPartInInterval(appointmentStartDate, appointmentEndDate, startDayHour, endDayHour)) {\n      var trimmedDates = this._trimDates(min, max);\n\n      min = trimmedDates.min;\n      max = new Date(trimmedDates.max.getTime() - toMs(\"minute\"));\n    }\n\n    if (recurrenceRule && !recurrenceProcessor.isValidRecurrenceRule(recurrenceRule)) {\n      result = appointmentEndDate > min && appointmentStartDate <= max;\n    }\n\n    if (result && recurrenceProcessor.isValidRecurrenceRule(recurrenceRule)) {\n      result = recurrenceProcessor.hasRecurrence({\n        rule: recurrenceRule,\n        exception: recurrenceException,\n        start: appointmentStartDate,\n        end: appointmentEndDate,\n        min: min,\n        max: max,\n        firstDayOfWeek: firstDayOfWeek\n      });\n    }\n\n    return result;\n  };\n\n  _proto2._appointmentPartInInterval = function (startDate, endDate, startDayHour, endDayHour) {\n    var apptStartDayHour = startDate.getHours();\n    var apptEndDayHour = endDate.getHours();\n    return apptStartDayHour <= startDayHour && apptEndDayHour <= endDayHour && apptEndDayHour >= startDayHour || apptEndDayHour >= endDayHour && apptStartDayHour <= endDayHour && apptStartDayHour >= startDayHour;\n  };\n\n  _proto2._createCombinedFilter = function (filterOptions, timeZoneCalculator) {\n    var dataAccessors = this._dataAccessors;\n    var min = new Date(filterOptions.min);\n    var max = new Date(filterOptions.max);\n    var getRecurrenceException = filterOptions.recurrenceException;\n    var startDayHour = filterOptions.startDayHour,\n        endDayHour = filterOptions.endDayHour,\n        viewStartDayHour = filterOptions.viewStartDayHour,\n        viewEndDayHour = filterOptions.viewEndDayHour,\n        resources = filterOptions.resources,\n        firstDayOfWeek = filterOptions.firstDayOfWeek;\n    var that = this;\n    return [[function (appointment) {\n      var result = true;\n      var startDate = new Date(dataAccessors.getter.startDate(appointment));\n      var endDate = new Date(dataAccessors.getter.endDate(appointment));\n      var appointmentTakesAllDay = that.appointmentTakesAllDay(appointment, viewStartDayHour, viewEndDayHour);\n      var appointmentTakesSeveralDays = that.appointmentTakesSeveralDays(appointment);\n      var isAllDay = dataAccessors.getter.allDay(appointment);\n      var appointmentIsLong = appointmentTakesSeveralDays || appointmentTakesAllDay;\n      var useRecurrence = (0, _type.isDefined)(dataAccessors.getter.recurrenceRule);\n      var recurrenceRule;\n\n      if (useRecurrence) {\n        recurrenceRule = dataAccessors.getter.recurrenceRule(appointment);\n      }\n\n      if (resources && resources.length) {\n        result = that._filterAppointmentByResources(appointment, resources);\n      }\n\n      if (appointmentTakesAllDay && false === filterOptions.allDay) {\n        result = false;\n      }\n\n      var startDateTimeZone = dataAccessors.getter.startDateTimeZone(appointment);\n      var endDateTimeZone = dataAccessors.getter.endDateTimeZone(appointment);\n      var comparableStartDate = timeZoneCalculator.createDate(startDate, {\n        appointmentTimeZone: startDateTimeZone,\n        path: \"toGrid\"\n      });\n      var comparableEndDate = timeZoneCalculator.createDate(endDate, {\n        appointmentTimeZone: endDateTimeZone,\n        path: \"toGrid\"\n      });\n\n      if (result && useRecurrence) {\n        var recurrenceException = getRecurrenceException ? getRecurrenceException(appointment) : dataAccessors.getter.recurrenceException(appointment);\n        result = that._filterAppointmentByRRule({\n          startDate: comparableStartDate,\n          endDate: comparableEndDate,\n          recurrenceRule: recurrenceRule,\n          recurrenceException: recurrenceException,\n          allDay: appointmentTakesAllDay\n        }, min, max, startDayHour, endDayHour, firstDayOfWeek);\n      }\n\n      if (result && comparableEndDate < min && appointmentIsLong && !isAllDay && (!useRecurrence || useRecurrence && !recurrenceRule)) {\n        result = false;\n      }\n\n      if (result && void 0 !== startDayHour && (!useRecurrence || !filterOptions.isVirtualScrolling)) {\n        result = compareDateWithStartDayHour(comparableStartDate, comparableEndDate, startDayHour, appointmentTakesAllDay, appointmentTakesSeveralDays);\n      }\n\n      if (result && void 0 !== endDayHour) {\n        result = compareDateWithEndDayHour(comparableStartDate, comparableEndDate, startDayHour, endDayHour, appointmentTakesAllDay, appointmentTakesSeveralDays, max, min);\n      }\n\n      if (result && useRecurrence && !recurrenceRule) {\n        if (comparableEndDate < min && !isAllDay) {\n          result = false;\n        }\n      }\n\n      return result;\n    }]];\n  };\n\n  _proto2.setDataSource = function (dataSource) {\n    this._dataSource = dataSource;\n    this.cleanModelState();\n\n    this._initStoreChangeHandlers();\n\n    this._filterMaker && this._filterMaker.clearRegistry();\n  };\n\n  _proto2._initStoreChangeHandlers = function () {\n    var _this3 = this;\n\n    var dataSource = this._dataSource;\n    var store = null === dataSource || void 0 === dataSource ? void 0 : dataSource.store();\n\n    if (store) {\n      store.on(\"updating\", function (newItem) {\n        _this3._updatedAppointment = newItem;\n      });\n      store.on(\"push\", function (pushItems) {\n        var items = dataSource.items();\n        var keyName = store.key();\n        pushItems.forEach(function (pushItem) {\n          var itemExists = 0 !== items.filter(function (item) {\n            return item[keyName] === pushItem.key;\n          }).length;\n\n          if (itemExists) {\n            _this3._updatedAppointmentKeys.push({\n              key: keyName,\n              value: pushItem.key\n            });\n          } else {\n            items.push(pushItem.data);\n          }\n        });\n      });\n    }\n  };\n\n  _proto2.getUpdatedAppointment = function () {\n    return this._updatedAppointment;\n  };\n\n  _proto2.getUpdatedAppointmentKeys = function () {\n    return this._updatedAppointmentKeys;\n  };\n\n  _proto2.cleanModelState = function () {\n    this._updatedAppointment = null;\n    this._updatedAppointmentKeys = [];\n  };\n\n  _proto2.setDataAccessors = function (dataAccessors) {\n    this._dataAccessors = dataAccessors;\n    this._filterMaker = new FilterMaker(dataAccessors);\n  };\n\n  _proto2.filterByDate = function (min, max, remoteFiltering, dateSerializationFormat) {\n    if (!this._dataSource) {\n      return;\n    }\n\n    var trimmedDates = this._trimDates(min, max);\n\n    if (!this._filterMaker.isRegistered()) {\n      this._createFilter(trimmedDates.min, trimmedDates.max, remoteFiltering, dateSerializationFormat);\n    } else {\n      var _this$_dataSource$fil;\n\n      this._filterMaker.make(\"date\", [trimmedDates.min, trimmedDates.max]);\n\n      if ((null === (_this$_dataSource$fil = this._dataSource.filter()) || void 0 === _this$_dataSource$fil ? void 0 : _this$_dataSource$fil.length) > 1) {\n        var userFilter = this._serializeRemoteFilter([this._dataSource.filter()[1]], dateSerializationFormat);\n\n        this._filterMaker.make(\"user\", userFilter);\n      }\n\n      if (remoteFiltering) {\n        this._dataSource.filter(this._combineRemoteFilter(dateSerializationFormat));\n      }\n    }\n  };\n\n  _proto2._combineRemoteFilter = function (dateSerializationFormat) {\n    var combinedFilter = this._filterMaker.combine();\n\n    return this._serializeRemoteFilter(combinedFilter, dateSerializationFormat);\n  };\n\n  _proto2._serializeRemoteFilter = function (filter, dateSerializationFormat) {\n    if (!Array.isArray(filter)) {\n      return filter;\n    }\n\n    filter = (0, _extend.extend)([], filter);\n    var startDate = this._dataAccessors.expr.startDateExpr;\n    var endDate = this._dataAccessors.expr.endDateExpr;\n\n    if ((0, _type.isString)(filter[0])) {\n      if ((0, _config.default)().forceIsoDateParsing && filter.length > 1) {\n        if (filter[0] === startDate || filter[0] === endDate) {\n          filter[filter.length - 1] = _date_serialization.default.serializeDate(new Date(filter[filter.length - 1]), dateSerializationFormat);\n        }\n      }\n    }\n\n    for (var i = 0; i < filter.length; i++) {\n      filter[i] = this._serializeRemoteFilter(filter[i], dateSerializationFormat);\n    }\n\n    return filter;\n  };\n\n  _proto2._createAppointmentFilter = function (filterOptions, timeZoneCalculator) {\n    var combinedFilter = this._createCombinedFilter(filterOptions, timeZoneCalculator);\n\n    if (this._filterMaker.isRegistered()) {\n      this._filterMaker.make(\"user\", void 0);\n\n      var trimmedDates = this._trimDates(filterOptions.min, filterOptions.max);\n\n      this._filterMaker.make(\"date\", [trimmedDates.min, trimmedDates.max, true]);\n\n      var dateFilter = this.customizeDateFilter(this._filterMaker.combine(), timeZoneCalculator);\n      combinedFilter.push([dateFilter]);\n    }\n\n    return combinedFilter;\n  };\n\n  _proto2.filterLoadedAppointments = function (filterOption, timeZoneCalculator) {\n    var combinedFilter = this._createAppointmentFilter(filterOption, timeZoneCalculator);\n\n    return (0, _query.default)(this.getPreparedDataItems()).filter(combinedFilter).toArray();\n  };\n\n  _proto2.getPreparedDataItems = function () {\n    var _this4 = this;\n\n    var dataItems = this._dataSource.items();\n\n    return (0, _iterator.map)(dataItems, function (item) {\n      var startDate = new Date(_this4._dataAccessors.getter.startDate(item));\n      var endDate = new Date(_this4._dataAccessors.getter.endDate(item));\n\n      _this4.replaceWrongEndDate(item, startDate, endDate);\n\n      return item;\n    });\n  };\n\n  _proto2.replaceWrongEndDate = function (appointment, startDate, endDate) {\n    if (this._isEndDateWrong(startDate, endDate)) {\n      var isAllDay = this._dataAccessors.getter.allDay(appointment);\n\n      var calculatedEndDate = this._calculateAppointmentEndDate(isAllDay, startDate);\n\n      this._dataAccessors.setter.endDate(appointment, calculatedEndDate);\n    }\n  };\n\n  _proto2.filterLoadedVirtualAppointments = function (filterOptions, timeZoneCalculator, groupCount) {\n    var _this5 = this;\n\n    var combinedFilters = [];\n    var itemsToFilter = this.getPreparedDataItems();\n    var needPreFilter = groupCount > 0;\n\n    if (needPreFilter) {\n      itemsToFilter = itemsToFilter.filter(function (item) {\n        for (var i = 0; i < filterOptions.length; ++i) {\n          var resources = filterOptions[i].resources;\n\n          if (_this5._filterAppointmentByResources(item, resources)) {\n            return true;\n          }\n        }\n      });\n    }\n\n    filterOptions.forEach(function (filterOption) {\n      combinedFilters.length && combinedFilters.push(\"or\");\n\n      var filter = _this5._createAppointmentFilter(filterOption, timeZoneCalculator);\n\n      combinedFilters.push(filter);\n    });\n    return (0, _query.default)(itemsToFilter).filter(combinedFilters).toArray();\n  };\n\n  _proto2._trimDates = function (min, max) {\n    var minCopy = _date.default.trimTime(new Date(min));\n\n    var maxCopy = _date.default.trimTime(new Date(max));\n\n    maxCopy.setDate(maxCopy.getDate() + 1);\n    return {\n      min: minCopy,\n      max: maxCopy\n    };\n  };\n\n  _proto2.hasAllDayAppointments = function (items, startDayHour, endDayHour) {\n    if (!items) {\n      return false;\n    }\n\n    var that = this;\n    var result = false;\n    (0, _iterator.each)(items, function (index, item) {\n      if (that.appointmentTakesAllDay(item, startDayHour, endDayHour)) {\n        result = true;\n        return false;\n      }\n    });\n    return result;\n  };\n\n  _proto2.appointmentTakesAllDay = function (appointment, startDayHour, endDayHour) {\n    var dataAccessors = this._dataAccessors;\n    var startDate = dataAccessors.getter.startDate(appointment);\n    var endDate = dataAccessors.getter.endDate(appointment);\n    var allDay = dataAccessors.getter.allDay(appointment);\n    return allDay || this._appointmentHasAllDayDuration(startDate, endDate, startDayHour, endDayHour);\n  };\n\n  _proto2._appointmentHasAllDayDuration = function (startDate, endDate, startDayHour, endDayHour) {\n    startDate = new Date(startDate);\n    endDate = new Date(endDate);\n    var dayDuration = 24;\n\n    var appointmentDurationInHours = this._getAppointmentDurationInHours(startDate, endDate);\n\n    return appointmentDurationInHours >= dayDuration || this._appointmentHasShortDayDuration(startDate, endDate, startDayHour, endDayHour);\n  };\n\n  _proto2._appointmentHasShortDayDuration = function (startDate, endDate, startDayHour, endDayHour) {\n    var appointmentDurationInHours = this._getAppointmentDurationInHours(startDate, endDate);\n\n    var shortDayDurationInHours = endDayHour - startDayHour;\n    return appointmentDurationInHours >= shortDayDurationInHours && startDate.getHours() === startDayHour && endDate.getHours() === endDayHour;\n  };\n\n  _proto2._getAppointmentDurationInHours = function (startDate, endDate) {\n    return (endDate.getTime() - startDate.getTime()) / toMs(\"hour\");\n  };\n\n  _proto2.appointmentTakesSeveralDays = function (appointment) {\n    var dataAccessors = this._dataAccessors;\n    var startDate = new Date(dataAccessors.getter.startDate(appointment));\n    var endDate = new Date(dataAccessors.getter.endDate(appointment));\n    return !_date.default.sameDate(startDate, endDate);\n  };\n\n  _proto2.customizeDateFilter = function (dateFilter, timeZoneCalculator) {\n    var _this6 = this;\n\n    var currentFilter = (0, _extend.extend)(true, [], dateFilter);\n    return function (appointment) {\n      var startDate = new Date(_this6._dataAccessors.getter.startDate(appointment));\n      var endDate = new Date(_this6._dataAccessors.getter.endDate(appointment));\n      appointment = (0, _extend.extend)(true, {}, appointment);\n\n      var startDateTimeZone = _this6._dataAccessors.getter.startDateTimeZone(appointment);\n\n      var endDateTimeZone = _this6._dataAccessors.getter.endDateTimeZone(appointment);\n\n      var comparableStartDate = timeZoneCalculator.createDate(startDate, {\n        appointmentTimeZone: startDateTimeZone,\n        path: \"toGrid\"\n      });\n      var comparableEndDate = timeZoneCalculator.createDate(endDate, {\n        appointmentTimeZone: endDateTimeZone,\n        path: \"toGrid\"\n      });\n\n      _this6._dataAccessors.setter.startDate(appointment, comparableStartDate);\n\n      _this6._dataAccessors.setter.endDate(appointment, comparableEndDate);\n\n      return (0, _query.default)([appointment]).filter(currentFilter).toArray().length > 0;\n    }.bind(this);\n  };\n\n  _proto2._calculateAppointmentEndDate = function (isAllDay, startDate) {\n    if (isAllDay) {\n      return _date.default.setToDayEnd(new Date(startDate));\n    }\n\n    return new Date(startDate.getTime() + this._baseAppointmentDuration * toMs(\"minute\"));\n  };\n\n  _proto2._isEndDateWrong = function (startDate, endDate) {\n    return !endDate || isNaN(endDate.getTime()) || startDate.getTime() > endDate.getTime();\n  };\n\n  _proto2.add = function (rawAppointment) {\n    var _this7 = this;\n\n    return this._dataSource.store().insert(rawAppointment).done(function () {\n      return _this7._dataSource.load();\n    });\n  };\n\n  _proto2.update = function (target, data) {\n    var _this8 = this;\n\n    var key = this._getStoreKey(target);\n\n    var d = new _deferred.Deferred();\n\n    this._dataSource.store().update(key, data).done(function (result) {\n      return _this8._dataSource.load().done(function () {\n        return d.resolve(result);\n      }).fail(d.reject);\n    }).fail(d.reject);\n\n    return d.promise();\n  };\n\n  _proto2.remove = function (rawAppointment) {\n    var _this9 = this;\n\n    var key = this._getStoreKey(rawAppointment);\n\n    return this._dataSource.store().remove(key).done(function () {\n      return _this9._dataSource.load();\n    });\n  };\n\n  _createClass(AppointmentModel, [{\n    key: \"keyName\",\n    get: function () {\n      var store = this._dataSource.store();\n\n      return store.key();\n    }\n  }]);\n\n  return AppointmentModel;\n}();\n\nvar _default = AppointmentModel;\nexports.default = _default;\nmodule.exports = exports.default;","map":{"version":3,"sources":["C:/Smart-Virtual-Classroom/client/node_modules/devextreme/ui/scheduler/ui.scheduler.appointment_model.js"],"names":["exports","default","_config","_interopRequireDefault","require","_iterator","_date_serialization","_recurrence","_date","_common","_type","_array","_extend","_query","_deferred","obj","__esModule","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","key","_createClass","Constructor","protoProps","staticProps","prototype","toMs","dateToMilliseconds","DATE_FILTER_POSITION","USER_FILTER_POSITION","FilterMaker","dataAccessors","_filterRegistry","_dataAccessors","_proto","isRegistered","clearRegistry","make","type","args","_make","apply","_this","min","max","useAccessors","startDate","getter","expr","startDateExpr","endDate","endDateExpr","recurrenceRule","recurrenceRuleExpr","date","splice","userFilter","user","combine","filter","push","dateFilter","compareDateWithStartDayHour","startDayHour","allDay","severalDays","startTime","dateTimeFromDecimal","result","getHours","hours","getMinutes","minutes","compareDateWithEndDayHour","endDayHour","hiddenInterval","apptDuration","getTime","delta","apptStartHour","apptStartMinutes","endTime","AppointmentModel","dataSource","baseAppointmentDuration","setDataAccessors","setDataSource","_updatedAppointmentKeys","_filterMaker","_baseAppointmentDuration","_proto2","_createFilter","remoteFiltering","dateSerializationFormat","userFilterPosition","_excessFiltering","_dataSource","_combineRemoteFilter","dataSourceFilter","equalByValue","_combineFilter","_getStoreKey","store","keyOf","_filterAppointmentByResources","appointment","resources","_this2","len","resourceName","checkAppointmentResourceValues","resourceGetter","resource","isFunction","appointmentResourceValues","wrapToArray","resourceData","map","items","item","id","j","itemDataCount","inArray","name","call","_filterAppointmentByRRule","firstDayOfWeek","recurrenceException","appointmentStartDate","appointmentEndDate","recurrenceProcessor","getRecurrenceProcessor","_appointmentPartInInterval","trimmedDates","_trimDates","Date","isValidRecurrenceRule","hasRecurrence","rule","exception","start","end","apptStartDayHour","apptEndDayHour","_createCombinedFilter","filterOptions","timeZoneCalculator","getRecurrenceException","viewStartDayHour","viewEndDayHour","that","appointmentTakesAllDay","appointmentTakesSeveralDays","isAllDay","appointmentIsLong","useRecurrence","isDefined","startDateTimeZone","endDateTimeZone","comparableStartDate","createDate","appointmentTimeZone","path","comparableEndDate","isVirtualScrolling","cleanModelState","_initStoreChangeHandlers","_this3","on","newItem","_updatedAppointment","pushItems","keyName","forEach","pushItem","itemExists","value","data","getUpdatedAppointment","getUpdatedAppointmentKeys","filterByDate","_this$_dataSource$fil","_serializeRemoteFilter","combinedFilter","Array","isArray","extend","isString","forceIsoDateParsing","serializeDate","_createAppointmentFilter","customizeDateFilter","filterLoadedAppointments","filterOption","getPreparedDataItems","toArray","_this4","dataItems","replaceWrongEndDate","_isEndDateWrong","calculatedEndDate","_calculateAppointmentEndDate","setter","filterLoadedVirtualAppointments","groupCount","_this5","combinedFilters","itemsToFilter","needPreFilter","minCopy","trimTime","maxCopy","setDate","getDate","hasAllDayAppointments","each","index","_appointmentHasAllDayDuration","dayDuration","appointmentDurationInHours","_getAppointmentDurationInHours","_appointmentHasShortDayDuration","shortDayDurationInHours","sameDate","_this6","currentFilter","bind","setToDayEnd","isNaN","add","rawAppointment","_this7","insert","done","load","update","_this8","d","Deferred","resolve","fail","reject","promise","remove","_this9","get","_default","module"],"mappings":"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","sourcesContent":["/**\r\n * DevExtreme (ui/scheduler/ui.scheduler.appointment_model.js)\r\n * Version: 20.2.6\r\n * Build date: Tue Mar 16 2021\r\n *\r\n * Copyright (c) 2012 - 2021 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\r\n\"use strict\";\r\nexports.default = void 0;\r\nvar _config = _interopRequireDefault(require(\"../../core/config\"));\r\nvar _iterator = require(\"../../core/utils/iterator\");\r\nvar _date_serialization = _interopRequireDefault(require(\"../../core/utils/date_serialization\"));\r\nvar _recurrence = require(\"./recurrence\");\r\nvar _date = _interopRequireDefault(require(\"../../core/utils/date\"));\r\nvar _common = require(\"../../core/utils/common\");\r\nvar _type = require(\"../../core/utils/type\");\r\nvar _array = require(\"../../core/utils/array\");\r\nvar _extend = require(\"../../core/utils/extend\");\r\nvar _query = _interopRequireDefault(require(\"../../data/query\"));\r\nvar _deferred = require(\"../../core/utils/deferred\");\r\n\r\nfunction _interopRequireDefault(obj) {\r\n    return obj && obj.__esModule ? obj : {\r\n        \"default\": obj\r\n    }\r\n}\r\n\r\nfunction _defineProperties(target, props) {\r\n    for (var i = 0; i < props.length; i++) {\r\n        var descriptor = props[i];\r\n        descriptor.enumerable = descriptor.enumerable || false;\r\n        descriptor.configurable = true;\r\n        if (\"value\" in descriptor) {\r\n            descriptor.writable = true\r\n        }\r\n        Object.defineProperty(target, descriptor.key, descriptor)\r\n    }\r\n}\r\n\r\nfunction _createClass(Constructor, protoProps, staticProps) {\r\n    if (protoProps) {\r\n        _defineProperties(Constructor.prototype, protoProps)\r\n    }\r\n    if (staticProps) {\r\n        _defineProperties(Constructor, staticProps)\r\n    }\r\n    return Constructor\r\n}\r\nvar toMs = _date.default.dateToMilliseconds;\r\nvar DATE_FILTER_POSITION = 0;\r\nvar USER_FILTER_POSITION = 1;\r\nvar FilterMaker = function() {\r\n    function FilterMaker(dataAccessors) {\r\n        this._filterRegistry = null;\r\n        this._dataAccessors = dataAccessors\r\n    }\r\n    var _proto = FilterMaker.prototype;\r\n    _proto.isRegistered = function() {\r\n        return !!this._filterRegistry\r\n    };\r\n    _proto.clearRegistry = function() {\r\n        delete this._filterRegistry\r\n    };\r\n    _proto.make = function(type, args) {\r\n        if (!this._filterRegistry) {\r\n            this._filterRegistry = {}\r\n        }\r\n        this._make(type).apply(this, args)\r\n    };\r\n    _proto._make = function(type) {\r\n        var _this = this;\r\n        switch (type) {\r\n            case \"date\":\r\n                return function(min, max, useAccessors) {\r\n                    var startDate = useAccessors ? _this._dataAccessors.getter.startDate : _this._dataAccessors.expr.startDateExpr;\r\n                    var endDate = useAccessors ? _this._dataAccessors.getter.endDate : _this._dataAccessors.expr.endDateExpr;\r\n                    var recurrenceRule = _this._dataAccessors.expr.recurrenceRuleExpr;\r\n                    _this._filterRegistry.date = [\r\n                        [\r\n                            [endDate, \">\", min],\r\n                            [startDate, \"<\", max]\r\n                        ], \"or\", [recurrenceRule, \"startswith\", \"freq\"], \"or\", [\r\n                            [endDate, min],\r\n                            [startDate, min]\r\n                        ]\r\n                    ];\r\n                    if (!recurrenceRule) {\r\n                        _this._filterRegistry.date.splice(1, 2)\r\n                    }\r\n                };\r\n            case \"user\":\r\n                return function(userFilter) {\r\n                    _this._filterRegistry.user = userFilter\r\n                }\r\n        }\r\n    };\r\n    _proto.combine = function() {\r\n        var filter = [];\r\n        this._filterRegistry.date && filter.push(this._filterRegistry.date);\r\n        this._filterRegistry.user && filter.push(this._filterRegistry.user);\r\n        return filter\r\n    };\r\n    _proto.dateFilter = function() {\r\n        return this._filterRegistry.date\r\n    };\r\n    return FilterMaker\r\n}();\r\nvar compareDateWithStartDayHour = function(startDate, endDate, startDayHour, allDay, severalDays) {\r\n    var startTime = _date.default.dateTimeFromDecimal(startDayHour);\r\n    var result = startDate.getHours() >= startTime.hours && startDate.getMinutes() >= startTime.minutes || endDate.getHours() === startTime.hours && endDate.getMinutes() > startTime.minutes || endDate.getHours() > startTime.hours || severalDays || allDay;\r\n    return result\r\n};\r\nvar compareDateWithEndDayHour = function(startDate, endDate, startDayHour, endDayHour, allDay, severalDays, max, min) {\r\n    var hiddenInterval = (24 - endDayHour + startDayHour) * toMs(\"hour\");\r\n    var apptDuration = endDate.getTime() - startDate.getTime();\r\n    var delta = (hiddenInterval - apptDuration) / toMs(\"hour\");\r\n    var apptStartHour = startDate.getHours();\r\n    var apptStartMinutes = startDate.getMinutes();\r\n    var result;\r\n    var endTime = _date.default.dateTimeFromDecimal(endDayHour);\r\n    var startTime = _date.default.dateTimeFromDecimal(startDayHour);\r\n    result = apptStartHour < endTime.hours || apptStartHour === endTime.hours && apptStartMinutes < endTime.minutes || allDay && startDate <= max || severalDays && startDate < max && endDate > min && (apptStartHour < endTime.hours || 60 * endDate.getHours() + endDate.getMinutes() > 60 * startTime.hours);\r\n    if (apptDuration < hiddenInterval) {\r\n        if (apptStartHour > endTime.hours && apptStartMinutes > endTime.minutes && delta <= apptStartHour - endDayHour) {\r\n            result = false\r\n        }\r\n    }\r\n    return result\r\n};\r\nvar AppointmentModel = function() {\r\n    function AppointmentModel(dataSource, dataAccessors, baseAppointmentDuration) {\r\n        this.setDataAccessors(dataAccessors);\r\n        this.setDataSource(dataSource);\r\n        this._updatedAppointmentKeys = [];\r\n        this._filterMaker = new FilterMaker(dataAccessors);\r\n        this._baseAppointmentDuration = baseAppointmentDuration\r\n    }\r\n    var _proto2 = AppointmentModel.prototype;\r\n    _proto2._createFilter = function(min, max, remoteFiltering, dateSerializationFormat) {\r\n        this._filterMaker.make(\"date\", [min, max]);\r\n        var userFilterPosition = this._excessFiltering() ? this._dataSource.filter()[USER_FILTER_POSITION] : this._dataSource.filter();\r\n        this._filterMaker.make(\"user\", [userFilterPosition]);\r\n        if (remoteFiltering) {\r\n            this._dataSource.filter(this._combineRemoteFilter(dateSerializationFormat))\r\n        }\r\n    };\r\n    _proto2._excessFiltering = function() {\r\n        var dateFilter = this._filterMaker.dateFilter();\r\n        var dataSourceFilter = this._dataSource.filter();\r\n        return dataSourceFilter && ((0, _common.equalByValue)(dataSourceFilter, dateFilter) || dataSourceFilter.length && (0, _common.equalByValue)(dataSourceFilter[DATE_FILTER_POSITION], dateFilter))\r\n    };\r\n    _proto2._combineFilter = function() {\r\n        return this._filterMaker.combine()\r\n    };\r\n    _proto2._getStoreKey = function(target) {\r\n        var store = this._dataSource.store();\r\n        return store.keyOf(target)\r\n    };\r\n    _proto2._filterAppointmentByResources = function(appointment, resources) {\r\n        var _this2 = this;\r\n        var result = false;\r\n        var i;\r\n        var len;\r\n        var resourceName;\r\n        var checkAppointmentResourceValues = function() {\r\n            var resourceGetter = _this2._dataAccessors.getter.resources[resourceName];\r\n            var resource;\r\n            if ((0, _type.isFunction)(resourceGetter)) {\r\n                resource = resourceGetter(appointment)\r\n            }\r\n            var appointmentResourceValues = (0, _array.wrapToArray)(resource);\r\n            var resourceData = (0, _iterator.map)(resources[i].items, function(item) {\r\n                return item.id\r\n            });\r\n            for (var j = 0, itemDataCount = appointmentResourceValues.length; j < itemDataCount; j++) {\r\n                if ((0, _array.inArray)(appointmentResourceValues[j], resourceData) > -1) {\r\n                    return true\r\n                }\r\n            }\r\n            return false\r\n        };\r\n        for (i = 0, len = resources.length; i < len; i++) {\r\n            resourceName = resources[i].name;\r\n            result = checkAppointmentResourceValues.call(this);\r\n            if (!result) {\r\n                return false\r\n            }\r\n        }\r\n        return result\r\n    };\r\n    _proto2._filterAppointmentByRRule = function(appointment, min, max, startDayHour, endDayHour, firstDayOfWeek) {\r\n        var recurrenceRule = appointment.recurrenceRule;\r\n        var recurrenceException = appointment.recurrenceException;\r\n        var allDay = appointment.allDay;\r\n        var result = true;\r\n        var appointmentStartDate = appointment.startDate;\r\n        var appointmentEndDate = appointment.endDate;\r\n        var recurrenceProcessor = (0, _recurrence.getRecurrenceProcessor)();\r\n        if (allDay || this._appointmentPartInInterval(appointmentStartDate, appointmentEndDate, startDayHour, endDayHour)) {\r\n            var trimmedDates = this._trimDates(min, max);\r\n            min = trimmedDates.min;\r\n            max = new Date(trimmedDates.max.getTime() - toMs(\"minute\"))\r\n        }\r\n        if (recurrenceRule && !recurrenceProcessor.isValidRecurrenceRule(recurrenceRule)) {\r\n            result = appointmentEndDate > min && appointmentStartDate <= max\r\n        }\r\n        if (result && recurrenceProcessor.isValidRecurrenceRule(recurrenceRule)) {\r\n            result = recurrenceProcessor.hasRecurrence({\r\n                rule: recurrenceRule,\r\n                exception: recurrenceException,\r\n                start: appointmentStartDate,\r\n                end: appointmentEndDate,\r\n                min: min,\r\n                max: max,\r\n                firstDayOfWeek: firstDayOfWeek\r\n            })\r\n        }\r\n        return result\r\n    };\r\n    _proto2._appointmentPartInInterval = function(startDate, endDate, startDayHour, endDayHour) {\r\n        var apptStartDayHour = startDate.getHours();\r\n        var apptEndDayHour = endDate.getHours();\r\n        return apptStartDayHour <= startDayHour && apptEndDayHour <= endDayHour && apptEndDayHour >= startDayHour || apptEndDayHour >= endDayHour && apptStartDayHour <= endDayHour && apptStartDayHour >= startDayHour\r\n    };\r\n    _proto2._createCombinedFilter = function(filterOptions, timeZoneCalculator) {\r\n        var dataAccessors = this._dataAccessors;\r\n        var min = new Date(filterOptions.min);\r\n        var max = new Date(filterOptions.max);\r\n        var getRecurrenceException = filterOptions.recurrenceException;\r\n        var startDayHour = filterOptions.startDayHour,\r\n            endDayHour = filterOptions.endDayHour,\r\n            viewStartDayHour = filterOptions.viewStartDayHour,\r\n            viewEndDayHour = filterOptions.viewEndDayHour,\r\n            resources = filterOptions.resources,\r\n            firstDayOfWeek = filterOptions.firstDayOfWeek;\r\n        var that = this;\r\n        return [\r\n            [function(appointment) {\r\n                var result = true;\r\n                var startDate = new Date(dataAccessors.getter.startDate(appointment));\r\n                var endDate = new Date(dataAccessors.getter.endDate(appointment));\r\n                var appointmentTakesAllDay = that.appointmentTakesAllDay(appointment, viewStartDayHour, viewEndDayHour);\r\n                var appointmentTakesSeveralDays = that.appointmentTakesSeveralDays(appointment);\r\n                var isAllDay = dataAccessors.getter.allDay(appointment);\r\n                var appointmentIsLong = appointmentTakesSeveralDays || appointmentTakesAllDay;\r\n                var useRecurrence = (0, _type.isDefined)(dataAccessors.getter.recurrenceRule);\r\n                var recurrenceRule;\r\n                if (useRecurrence) {\r\n                    recurrenceRule = dataAccessors.getter.recurrenceRule(appointment)\r\n                }\r\n                if (resources && resources.length) {\r\n                    result = that._filterAppointmentByResources(appointment, resources)\r\n                }\r\n                if (appointmentTakesAllDay && false === filterOptions.allDay) {\r\n                    result = false\r\n                }\r\n                var startDateTimeZone = dataAccessors.getter.startDateTimeZone(appointment);\r\n                var endDateTimeZone = dataAccessors.getter.endDateTimeZone(appointment);\r\n                var comparableStartDate = timeZoneCalculator.createDate(startDate, {\r\n                    appointmentTimeZone: startDateTimeZone,\r\n                    path: \"toGrid\"\r\n                });\r\n                var comparableEndDate = timeZoneCalculator.createDate(endDate, {\r\n                    appointmentTimeZone: endDateTimeZone,\r\n                    path: \"toGrid\"\r\n                });\r\n                if (result && useRecurrence) {\r\n                    var recurrenceException = getRecurrenceException ? getRecurrenceException(appointment) : dataAccessors.getter.recurrenceException(appointment);\r\n                    result = that._filterAppointmentByRRule({\r\n                        startDate: comparableStartDate,\r\n                        endDate: comparableEndDate,\r\n                        recurrenceRule: recurrenceRule,\r\n                        recurrenceException: recurrenceException,\r\n                        allDay: appointmentTakesAllDay\r\n                    }, min, max, startDayHour, endDayHour, firstDayOfWeek)\r\n                }\r\n                if (result && comparableEndDate < min && appointmentIsLong && !isAllDay && (!useRecurrence || useRecurrence && !recurrenceRule)) {\r\n                    result = false\r\n                }\r\n                if (result && void 0 !== startDayHour && (!useRecurrence || !filterOptions.isVirtualScrolling)) {\r\n                    result = compareDateWithStartDayHour(comparableStartDate, comparableEndDate, startDayHour, appointmentTakesAllDay, appointmentTakesSeveralDays)\r\n                }\r\n                if (result && void 0 !== endDayHour) {\r\n                    result = compareDateWithEndDayHour(comparableStartDate, comparableEndDate, startDayHour, endDayHour, appointmentTakesAllDay, appointmentTakesSeveralDays, max, min)\r\n                }\r\n                if (result && useRecurrence && !recurrenceRule) {\r\n                    if (comparableEndDate < min && !isAllDay) {\r\n                        result = false\r\n                    }\r\n                }\r\n                return result\r\n            }]\r\n        ]\r\n    };\r\n    _proto2.setDataSource = function(dataSource) {\r\n        this._dataSource = dataSource;\r\n        this.cleanModelState();\r\n        this._initStoreChangeHandlers();\r\n        this._filterMaker && this._filterMaker.clearRegistry()\r\n    };\r\n    _proto2._initStoreChangeHandlers = function() {\r\n        var _this3 = this;\r\n        var dataSource = this._dataSource;\r\n        var store = null === dataSource || void 0 === dataSource ? void 0 : dataSource.store();\r\n        if (store) {\r\n            store.on(\"updating\", function(newItem) {\r\n                _this3._updatedAppointment = newItem\r\n            });\r\n            store.on(\"push\", function(pushItems) {\r\n                var items = dataSource.items();\r\n                var keyName = store.key();\r\n                pushItems.forEach(function(pushItem) {\r\n                    var itemExists = 0 !== items.filter(function(item) {\r\n                        return item[keyName] === pushItem.key\r\n                    }).length;\r\n                    if (itemExists) {\r\n                        _this3._updatedAppointmentKeys.push({\r\n                            key: keyName,\r\n                            value: pushItem.key\r\n                        })\r\n                    } else {\r\n                        items.push(pushItem.data)\r\n                    }\r\n                })\r\n            })\r\n        }\r\n    };\r\n    _proto2.getUpdatedAppointment = function() {\r\n        return this._updatedAppointment\r\n    };\r\n    _proto2.getUpdatedAppointmentKeys = function() {\r\n        return this._updatedAppointmentKeys\r\n    };\r\n    _proto2.cleanModelState = function() {\r\n        this._updatedAppointment = null;\r\n        this._updatedAppointmentKeys = []\r\n    };\r\n    _proto2.setDataAccessors = function(dataAccessors) {\r\n        this._dataAccessors = dataAccessors;\r\n        this._filterMaker = new FilterMaker(dataAccessors)\r\n    };\r\n    _proto2.filterByDate = function(min, max, remoteFiltering, dateSerializationFormat) {\r\n        if (!this._dataSource) {\r\n            return\r\n        }\r\n        var trimmedDates = this._trimDates(min, max);\r\n        if (!this._filterMaker.isRegistered()) {\r\n            this._createFilter(trimmedDates.min, trimmedDates.max, remoteFiltering, dateSerializationFormat)\r\n        } else {\r\n            var _this$_dataSource$fil;\r\n            this._filterMaker.make(\"date\", [trimmedDates.min, trimmedDates.max]);\r\n            if ((null === (_this$_dataSource$fil = this._dataSource.filter()) || void 0 === _this$_dataSource$fil ? void 0 : _this$_dataSource$fil.length) > 1) {\r\n                var userFilter = this._serializeRemoteFilter([this._dataSource.filter()[1]], dateSerializationFormat);\r\n                this._filterMaker.make(\"user\", userFilter)\r\n            }\r\n            if (remoteFiltering) {\r\n                this._dataSource.filter(this._combineRemoteFilter(dateSerializationFormat))\r\n            }\r\n        }\r\n    };\r\n    _proto2._combineRemoteFilter = function(dateSerializationFormat) {\r\n        var combinedFilter = this._filterMaker.combine();\r\n        return this._serializeRemoteFilter(combinedFilter, dateSerializationFormat)\r\n    };\r\n    _proto2._serializeRemoteFilter = function(filter, dateSerializationFormat) {\r\n        if (!Array.isArray(filter)) {\r\n            return filter\r\n        }\r\n        filter = (0, _extend.extend)([], filter);\r\n        var startDate = this._dataAccessors.expr.startDateExpr;\r\n        var endDate = this._dataAccessors.expr.endDateExpr;\r\n        if ((0, _type.isString)(filter[0])) {\r\n            if ((0, _config.default)().forceIsoDateParsing && filter.length > 1) {\r\n                if (filter[0] === startDate || filter[0] === endDate) {\r\n                    filter[filter.length - 1] = _date_serialization.default.serializeDate(new Date(filter[filter.length - 1]), dateSerializationFormat)\r\n                }\r\n            }\r\n        }\r\n        for (var i = 0; i < filter.length; i++) {\r\n            filter[i] = this._serializeRemoteFilter(filter[i], dateSerializationFormat)\r\n        }\r\n        return filter\r\n    };\r\n    _proto2._createAppointmentFilter = function(filterOptions, timeZoneCalculator) {\r\n        var combinedFilter = this._createCombinedFilter(filterOptions, timeZoneCalculator);\r\n        if (this._filterMaker.isRegistered()) {\r\n            this._filterMaker.make(\"user\", void 0);\r\n            var trimmedDates = this._trimDates(filterOptions.min, filterOptions.max);\r\n            this._filterMaker.make(\"date\", [trimmedDates.min, trimmedDates.max, true]);\r\n            var dateFilter = this.customizeDateFilter(this._filterMaker.combine(), timeZoneCalculator);\r\n            combinedFilter.push([dateFilter])\r\n        }\r\n        return combinedFilter\r\n    };\r\n    _proto2.filterLoadedAppointments = function(filterOption, timeZoneCalculator) {\r\n        var combinedFilter = this._createAppointmentFilter(filterOption, timeZoneCalculator);\r\n        return (0, _query.default)(this.getPreparedDataItems()).filter(combinedFilter).toArray()\r\n    };\r\n    _proto2.getPreparedDataItems = function() {\r\n        var _this4 = this;\r\n        var dataItems = this._dataSource.items();\r\n        return (0, _iterator.map)(dataItems, function(item) {\r\n            var startDate = new Date(_this4._dataAccessors.getter.startDate(item));\r\n            var endDate = new Date(_this4._dataAccessors.getter.endDate(item));\r\n            _this4.replaceWrongEndDate(item, startDate, endDate);\r\n            return item\r\n        })\r\n    };\r\n    _proto2.replaceWrongEndDate = function(appointment, startDate, endDate) {\r\n        if (this._isEndDateWrong(startDate, endDate)) {\r\n            var isAllDay = this._dataAccessors.getter.allDay(appointment);\r\n            var calculatedEndDate = this._calculateAppointmentEndDate(isAllDay, startDate);\r\n            this._dataAccessors.setter.endDate(appointment, calculatedEndDate)\r\n        }\r\n    };\r\n    _proto2.filterLoadedVirtualAppointments = function(filterOptions, timeZoneCalculator, groupCount) {\r\n        var _this5 = this;\r\n        var combinedFilters = [];\r\n        var itemsToFilter = this.getPreparedDataItems();\r\n        var needPreFilter = groupCount > 0;\r\n        if (needPreFilter) {\r\n            itemsToFilter = itemsToFilter.filter(function(item) {\r\n                for (var i = 0; i < filterOptions.length; ++i) {\r\n                    var resources = filterOptions[i].resources;\r\n                    if (_this5._filterAppointmentByResources(item, resources)) {\r\n                        return true\r\n                    }\r\n                }\r\n            })\r\n        }\r\n        filterOptions.forEach(function(filterOption) {\r\n            combinedFilters.length && combinedFilters.push(\"or\");\r\n            var filter = _this5._createAppointmentFilter(filterOption, timeZoneCalculator);\r\n            combinedFilters.push(filter)\r\n        });\r\n        return (0, _query.default)(itemsToFilter).filter(combinedFilters).toArray()\r\n    };\r\n    _proto2._trimDates = function(min, max) {\r\n        var minCopy = _date.default.trimTime(new Date(min));\r\n        var maxCopy = _date.default.trimTime(new Date(max));\r\n        maxCopy.setDate(maxCopy.getDate() + 1);\r\n        return {\r\n            min: minCopy,\r\n            max: maxCopy\r\n        }\r\n    };\r\n    _proto2.hasAllDayAppointments = function(items, startDayHour, endDayHour) {\r\n        if (!items) {\r\n            return false\r\n        }\r\n        var that = this;\r\n        var result = false;\r\n        (0, _iterator.each)(items, function(index, item) {\r\n            if (that.appointmentTakesAllDay(item, startDayHour, endDayHour)) {\r\n                result = true;\r\n                return false\r\n            }\r\n        });\r\n        return result\r\n    };\r\n    _proto2.appointmentTakesAllDay = function(appointment, startDayHour, endDayHour) {\r\n        var dataAccessors = this._dataAccessors;\r\n        var startDate = dataAccessors.getter.startDate(appointment);\r\n        var endDate = dataAccessors.getter.endDate(appointment);\r\n        var allDay = dataAccessors.getter.allDay(appointment);\r\n        return allDay || this._appointmentHasAllDayDuration(startDate, endDate, startDayHour, endDayHour)\r\n    };\r\n    _proto2._appointmentHasAllDayDuration = function(startDate, endDate, startDayHour, endDayHour) {\r\n        startDate = new Date(startDate);\r\n        endDate = new Date(endDate);\r\n        var dayDuration = 24;\r\n        var appointmentDurationInHours = this._getAppointmentDurationInHours(startDate, endDate);\r\n        return appointmentDurationInHours >= dayDuration || this._appointmentHasShortDayDuration(startDate, endDate, startDayHour, endDayHour)\r\n    };\r\n    _proto2._appointmentHasShortDayDuration = function(startDate, endDate, startDayHour, endDayHour) {\r\n        var appointmentDurationInHours = this._getAppointmentDurationInHours(startDate, endDate);\r\n        var shortDayDurationInHours = endDayHour - startDayHour;\r\n        return appointmentDurationInHours >= shortDayDurationInHours && startDate.getHours() === startDayHour && endDate.getHours() === endDayHour\r\n    };\r\n    _proto2._getAppointmentDurationInHours = function(startDate, endDate) {\r\n        return (endDate.getTime() - startDate.getTime()) / toMs(\"hour\")\r\n    };\r\n    _proto2.appointmentTakesSeveralDays = function(appointment) {\r\n        var dataAccessors = this._dataAccessors;\r\n        var startDate = new Date(dataAccessors.getter.startDate(appointment));\r\n        var endDate = new Date(dataAccessors.getter.endDate(appointment));\r\n        return !_date.default.sameDate(startDate, endDate)\r\n    };\r\n    _proto2.customizeDateFilter = function(dateFilter, timeZoneCalculator) {\r\n        var _this6 = this;\r\n        var currentFilter = (0, _extend.extend)(true, [], dateFilter);\r\n        return function(appointment) {\r\n            var startDate = new Date(_this6._dataAccessors.getter.startDate(appointment));\r\n            var endDate = new Date(_this6._dataAccessors.getter.endDate(appointment));\r\n            appointment = (0, _extend.extend)(true, {}, appointment);\r\n            var startDateTimeZone = _this6._dataAccessors.getter.startDateTimeZone(appointment);\r\n            var endDateTimeZone = _this6._dataAccessors.getter.endDateTimeZone(appointment);\r\n            var comparableStartDate = timeZoneCalculator.createDate(startDate, {\r\n                appointmentTimeZone: startDateTimeZone,\r\n                path: \"toGrid\"\r\n            });\r\n            var comparableEndDate = timeZoneCalculator.createDate(endDate, {\r\n                appointmentTimeZone: endDateTimeZone,\r\n                path: \"toGrid\"\r\n            });\r\n            _this6._dataAccessors.setter.startDate(appointment, comparableStartDate);\r\n            _this6._dataAccessors.setter.endDate(appointment, comparableEndDate);\r\n            return (0, _query.default)([appointment]).filter(currentFilter).toArray().length > 0\r\n        }.bind(this)\r\n    };\r\n    _proto2._calculateAppointmentEndDate = function(isAllDay, startDate) {\r\n        if (isAllDay) {\r\n            return _date.default.setToDayEnd(new Date(startDate))\r\n        }\r\n        return new Date(startDate.getTime() + this._baseAppointmentDuration * toMs(\"minute\"))\r\n    };\r\n    _proto2._isEndDateWrong = function(startDate, endDate) {\r\n        return !endDate || isNaN(endDate.getTime()) || startDate.getTime() > endDate.getTime()\r\n    };\r\n    _proto2.add = function(rawAppointment) {\r\n        var _this7 = this;\r\n        return this._dataSource.store().insert(rawAppointment).done(function() {\r\n            return _this7._dataSource.load()\r\n        })\r\n    };\r\n    _proto2.update = function(target, data) {\r\n        var _this8 = this;\r\n        var key = this._getStoreKey(target);\r\n        var d = new _deferred.Deferred;\r\n        this._dataSource.store().update(key, data).done(function(result) {\r\n            return _this8._dataSource.load().done(function() {\r\n                return d.resolve(result)\r\n            }).fail(d.reject)\r\n        }).fail(d.reject);\r\n        return d.promise()\r\n    };\r\n    _proto2.remove = function(rawAppointment) {\r\n        var _this9 = this;\r\n        var key = this._getStoreKey(rawAppointment);\r\n        return this._dataSource.store().remove(key).done(function() {\r\n            return _this9._dataSource.load()\r\n        })\r\n    };\r\n    _createClass(AppointmentModel, [{\r\n        key: \"keyName\",\r\n        get: function() {\r\n            var store = this._dataSource.store();\r\n            return store.key()\r\n        }\r\n    }]);\r\n    return AppointmentModel\r\n}();\r\nvar _default = AppointmentModel;\r\nexports.default = _default;\r\nmodule.exports = exports.default;\r\n"]},"metadata":{},"sourceType":"script"}